---
import BaseLayout from "../layouts/BaseLayout.astro";
import { journals } from "../data/journals";

const success = new URL(Astro.request.url).searchParams.get("success");
const error = new URL(Astro.request.url).searchParams.get("error");

const env = Astro.locals.runtime?.env as Record<string, any> | undefined;
const siteUrl = env?.SITE_URL || "https://rubbishpublishing.org";
const orcidClientId = env?.ORCID_CLIENT_ID || "";
const orcidScope = "/authenticate";
const orcidRedirectUri = `${siteUrl}/orcid/callback`;
const orcidAuthorizeBase = "https://orcid.org/oauth/authorize";

const positionOptions = [
	{ value: "Editorial Board Member", label: "Editorial Board Member" },
	{ value: "Associate Editor", label: "Associate Editor" },
	{ value: "Guest Editor", label: "Guest Editor" },
	{ value: "Statistical Editor", label: "Statistical Editor" },
	{ value: "Section Editor", label: "Section Editor" },
];
---

<BaseLayout title="Join Editorial Board - Rubbish Publishing Group">
	<div class="featured-section" style="padding: 2.5rem 0;">
		<div class="container">
			<h1 style="color: #fff; margin-bottom: 0.5rem;">Apply to Join the Editorial Board</h1>
			<p style="color: rgba(255,255,255,0.65); max-width: 760px;">
				Rubbish Publishing Group welcomes experienced researchers and editors to join our editorial board.
				All applications are reviewed by existing editors, and qualified candidates will be invited by email.
			</p>
		</div>
	</div>

	<div class="page-content">
		<div class="container" style="max-width: 760px;">
			{success && (
				<div class="alert alert-success">
					Your application has been submitted successfully. We will review it within 7 business days.
				</div>
			)}

			{error && (
				<div class="alert alert-error">
					{error === "missing_fields" ? "Please fill in all required fields." :
					 error === "invalid_email" ? "Please provide a valid email address." :
					 error === "invalid_orcid" ? "Please provide a valid ORCID iD (0000-0000-0000-0000)." :
					 error === "invalid_position" ? "Please choose a valid position from the list." :
					 error === "invalid_journal" ? "Please choose a valid journal." :
					 error === "invalid_file" ? "CV must be a PDF file no larger than 10MB." :
					 error === "invalid_form" ? "Submitted form is invalid. Please try again." :
					 error === "service_unavailable" ? "Service unavailable. Please try again later." :
					 "Failed to submit. Please try again later."}
				</div>
			)}

			<div class="card">
				<div class="card-header">
					<h2 style="font-size: 1.1rem;">Application Form</h2>
				</div>
				<div class="card-body">
					<form action="/api/board/apply" method="post" enctype="multipart/form-data" id="board-apply-form">
						<div class="grid-2">
							<div class="form-group">
								<label class="form-label" for="name">Full Name <span>*</span></label>
								<input type="text" id="name" name="name" class="form-input" required placeholder="Your legal name" />
							</div>
							<div class="form-group">
								<label class="form-label" for="email">Email Address <span>*</span></label>
								<input type="email" id="email" name="email" class="form-input" required placeholder="name@institution.edu" />
							</div>
						</div>

						<div class="form-group">
							<label class="form-label" for="affiliation">Institution / Organization <span>*</span></label>
							<input type="text" id="affiliation" name="affiliation" class="form-input" required placeholder="University / Institute / Company" />
						</div>

						<div class="form-group">
							<label class="form-label" for="orcid">ORCID iD <span>*</span></label>
							<div style="display: flex; gap: 0.6rem; flex-wrap: wrap; align-items: center;">
								<input type="text" id="orcid" name="orcid" class="form-input" style="flex:1; min-width: 240px;" required placeholder="0000-0000-0000-0000" />
								<button type="button" class="btn btn-secondary" id="orcid-connect-btn">Connect ORCID</button>
							</div>
							<p class="form-help" style="margin-top:0.45rem;">
								Need an ORCID iD? Visit
								<a href="https://orcid.org" target="_blank" rel="noopener noreferrer">orcid.org</a>.
							</p>
						</div>

						<div class="grid-2">
							<div class="form-group">
								<label class="form-label" for="journal-id">Target Journal <span>*</span></label>
								<select id="journal-id" name="journal_id" class="form-select" required>
									<option value="">Select a journal...</option>
									{journals.map((j) => (
										<option value={j.id}>{j.name}</option>
									))}
								</select>
							</div>
							<div class="form-group">
								<label class="form-label" for="position">Desired Position <span>*</span></label>
								<select id="position" name="position" class="form-select" required>
									<option value="">Select a position...</option>
									{positionOptions.map((p) => (
										<option value={p.value}>{p.label}</option>
									))}
								</select>
							</div>
						</div>

						<div class="form-group">
							<label class="form-label" for="expertise">Research Expertise <span>*</span></label>
							<input type="text" id="expertise" name="expertise" class="form-input" required placeholder="e.g., epidemiology, AI for medicine, peer review methods" />
						</div>

						<div class="form-group">
							<label class="form-label" for="bio">Short Bio <span>*</span></label>
							<textarea id="bio" name="bio" class="form-textarea" required rows="6" placeholder="Describe your editorial experience, academic background, and why you want to join this board..."></textarea>
						</div>

						<div class="form-group">
							<label class="form-label" for="cv">Curriculum Vitae (PDF, optional)</label>
							<div class="upload-area" id="cv-upload-area">
								<p>Click to upload your CV PDF</p>
								<p class="text-xs text-muted" style="margin-top: 0.5rem;">PDF only, max 10MB</p>
							</div>
							<input type="file" id="cv" name="cv" accept=".pdf" style="display: none;" />
							<p class="form-help" id="cv-filename"></p>
						</div>

						<div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
							<a href="/" class="btn btn-secondary">Cancel</a>
							<button type="submit" class="btn btn-primary btn-lg">Submit Application</button>
						</div>
					</form>
				</div>
			</div>
		</div>
	</div>
</BaseLayout>

<script define:vars={{ orcidClientId, orcidScope, orcidRedirectUri, orcidAuthorizeBase }}>
	const orcidPattern = /^\d{4}-\d{4}-\d{4}-[\dX]{4}$/i;
	const emailPattern = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

	function sanitizeOrcid(value) {
		return value.replace(/^https?:\/\/orcid\.org\//i, "").trim();
	}

	const cvInput = document.getElementById("cv");
	const cvUploadArea = document.getElementById("cv-upload-area");
	const cvFilename = document.getElementById("cv-filename");
	const form = document.getElementById("board-apply-form");
	const orcidInput = document.getElementById("orcid");
	const emailInput = document.getElementById("email");

	cvUploadArea?.addEventListener("click", () => cvInput?.click());

	cvInput?.addEventListener("change", (event) => {
		const input = event.target;
		if (input.files && input.files[0]) {
			cvFilename.textContent = `Selected: ${input.files[0].name}`;
		} else {
			cvFilename.textContent = "";
		}
	});

	form?.addEventListener("submit", (event) => {
		const sanitizedOrcid = sanitizeOrcid(orcidInput.value);
		orcidInput.value = sanitizedOrcid;
		if (!orcidPattern.test(sanitizedOrcid)) {
			event.preventDefault();
			alert("Invalid ORCID format. Please use 0000-0000-0000-0000.");
			return;
		}

		if (!emailPattern.test(emailInput.value.trim())) {
			event.preventDefault();
			alert("Please enter a valid email address.");
			return;
		}

		if (cvInput.files && cvInput.files[0]) {
			const file = cvInput.files[0];
			if (!file.name.toLowerCase().endsWith(".pdf") || file.size > 10 * 1024 * 1024) {
				event.preventDefault();
				alert("CV must be a PDF file no larger than 10MB.");
			}
		}
	});

	document.getElementById("orcid-connect-btn")?.addEventListener("click", () => {
		if (!orcidClientId) {
			alert("ORCID client is not configured yet. Please enter ORCID manually.");
			return;
		}
		const state = crypto.randomUUID();
		sessionStorage.setItem("orcid_oauth_state", state);
		const params = new URLSearchParams({
			client_id: orcidClientId,
			response_type: "code",
			scope: orcidScope,
			redirect_uri: orcidRedirectUri,
			state,
		});
		const popup = window.open(`${orcidAuthorizeBase}?${params.toString()}`, "orcid_oauth", "width=620,height=780");
		if (!popup) {
			alert("Popup blocked. Please allow popups and try again.");
		}
	});

	window.addEventListener("message", (event) => {
		if (event.origin !== window.location.origin) return;
		if (!event.data || event.data.type !== "orcid-oauth") return;
		const expected = sessionStorage.getItem("orcid_oauth_state");
		if (expected && event.data.state !== expected) return;
		if (event.data.orcid) {
			orcidInput.value = sanitizeOrcid(event.data.orcid);
		} else if (event.data.error) {
			alert("ORCID authorization was not completed. Please enter ORCID manually.");
		}
	});
</script>
