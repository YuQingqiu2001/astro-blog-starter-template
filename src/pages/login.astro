---
import BaseLayout from "../layouts/BaseLayout.astro";
import { getSession, getSessionToken } from "../lib/auth";

const token = getSessionToken(Astro.request);
const env = Astro.locals.runtime?.env;
if (token && env?.DB) {
	const session = await getSession({ kv: env.SESSIONS_KV, db: env.DB }, token);
	if (session) {
		return Astro.redirect(`/${session.role}`);
	}
}

const error = new URL(Astro.request.url).searchParams.get("error");
const redirect = new URL(Astro.request.url).searchParams.get("redirect") || "";
---

<BaseLayout title="Login - Rubbish Publishing Group">
	<div class="auth-page">
		<div class="auth-card">
			<h1>Sign In</h1>
			<p class="auth-subtitle">Rubbish Publishing Group ‚Äî Manuscript Submission & Review Platform</p>

			{error && (
				<div class="alert alert-error">
					{error === "invalid" ? "Incorrect email or password. Please try again." :
					 error === "role_mismatch" ? "This account type does not match your selected role tab." :
					 error === "captcha_failed" ? "Human verification failed. Please try again." :
					 error === "unavailable" ? "Service temporarily unavailable. Please try again later." : error}
				</div>
			)}

			<div class="role-tabs" id="role-tabs">
				<button class="role-tab active" data-role="author" type="button" id="tab-author">‚úèÔ∏è Author</button>
				<button class="role-tab" data-role="editor" type="button" id="tab-editor">üìã Editor</button>
				<button class="role-tab" data-role="reviewer" type="button" id="tab-reviewer">üîç Reviewer</button>
			</div>

			<form action="/api/auth/login" method="post" id="login-form">
				<input type="hidden" name="redirect" value={redirect} />
				<input type="hidden" name="role" id="role-input" value="author" />
				<input type="hidden" name="captcha_expected" id="captcha-expected" />

				<div class="form-group">
					<label class="form-label" for="email">Email Address</label>
					<input type="email" id="email" name="email" class="form-input" required autocomplete="email" placeholder="your@email.com" />
				</div>

				<div class="form-group">
					<label class="form-label" for="password">Password</label>
					<input type="password" id="password" name="password" class="form-input" required autocomplete="current-password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
				</div>

				<div class="form-group">
					<label class="form-label" for="captcha-answer">Human Verification</label>
					<div style="display:flex; gap:0.5rem; align-items:center; margin-bottom:0.5rem;">
						<strong id="captcha-question">Loading challenge...</strong>
						<button type="button" class="btn btn-sm btn-secondary" id="captcha-refresh">‚Üª Refresh</button>
					</div>
					<input type="text" id="captcha-answer" name="captcha_answer" class="form-input" required inputmode="numeric" placeholder="Enter answer" />
				</div>

				<button type="submit" class="btn btn-primary btn-full btn-lg" style="margin-top: 0.5rem;">Sign In</button>
			</form>

			<p style="text-align:center; margin-top: 0.75rem; font-size: 0.85rem; color: var(--text-secondary);">
				Forgot password? Please contact administrator or editorial office to reset your password.
			</p>

			<div class="auth-divider"><span>Don't have an account?</span></div>

			<div style="text-align: center;">
				<a href="/register" class="btn btn-secondary btn-full">Create Account</a>
			</div>

			<p style="text-align: center; margin-top: 1.25rem; font-size: 0.8rem; color: var(--text-light);">
				<a href="/join-editorial-board">Apply to join the Editorial Board</a>
			</p>
		</div>
	</div>
</BaseLayout>

<script>
	function activateRole(role) {
		document.querySelectorAll("#role-tabs .role-tab").forEach((tab) => {
			tab.classList.toggle("active", tab.dataset.role === role);
		});
		document.getElementById("role-input").value = role;
	}

	function regenCaptcha() {
		const a = Math.floor(Math.random() * 8) + 2;
		const b = Math.floor(Math.random() * 8) + 2;
		document.getElementById("captcha-question").textContent = `${a} + ${b} = ?`;
		document.getElementById("captcha-expected").value = String(a + b);
		document.getElementById("captcha-answer").value = "";
	}

	document.querySelectorAll("#role-tabs .role-tab").forEach((btn) => {
		btn.addEventListener("click", () => activateRole(btn.dataset.role));
	});

	document.getElementById("captcha-refresh")?.addEventListener("click", regenCaptcha);

	document.getElementById("login-form")?.addEventListener("submit", (e) => {
		const expected = document.getElementById("captcha-expected").value;
		const answer = document.getElementById("captcha-answer").value.trim();
		if (!answer || answer !== expected) {
			e.preventDefault();
			alert("Human verification failed. Please solve the math question.");
			regenCaptcha();
		}
	});

	activateRole("author");
	regenCaptcha();
</script>
