---
import BaseLayout from "../layouts/BaseLayout.astro";
import { getSession, getSessionToken } from "../lib/auth";

// If already logged in, redirect
const token = getSessionToken(Astro.request);
if (token && Astro.locals.runtime?.env?.SESSIONS_KV) {
	const session = await getSession(Astro.locals.runtime.env.SESSIONS_KV, token);
	if (session) {
		return Astro.redirect(`/${session.role}`);
	}
}

const error = new URL(Astro.request.url).searchParams.get("error");
const redirect = new URL(Astro.request.url).searchParams.get("redirect") || "";
---

<BaseLayout title="ç™»å½• - ç„å­¦å‰æ²¿æœŸåˆŠç¾¤">
	<div class="auth-page">
		<div class="auth-card">
			<h1>ç™»å½•ç³»ç»Ÿ</h1>
			<p class="auth-subtitle">ç„å­¦å‰æ²¿æœŸåˆŠæŠ•ç¨¿ä¸å®¡ç¨¿å¹³å°</p>

			{error && (
				<div class="alert alert-error">
					{error === "invalid" ? "é‚®ç®±æˆ–å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•ã€‚" : error}
				</div>
			)}

			<!-- Role tabs (visual only, for UX) -->
			<div class="role-tabs" id="role-tabs">
				<button class="role-tab active" onclick="setRole('author')" type="button" id="tab-author">
					âœï¸ ä½œè€…
				</button>
				<button class="role-tab" onclick="setRole('editor')" type="button" id="tab-editor">
					ğŸ“‹ ç¼–è¾‘
				</button>
				<button class="role-tab" onclick="setRole('reviewer')" type="button" id="tab-reviewer">
					ğŸ” å®¡ç¨¿äºº
				</button>
			</div>

			<form action="/api/auth/login" method="post">
				<input type="hidden" name="redirect" value={redirect} />

				<div class="form-group">
					<label class="form-label" for="email">é‚®ç®±åœ°å€</label>
					<input
						type="email"
						id="email"
						name="email"
						class="form-input"
						required
						autocomplete="email"
						placeholder="your@email.com"
					/>
				</div>

				<div class="form-group">
					<label class="form-label" for="password">å¯†ç </label>
					<input
						type="password"
						id="password"
						name="password"
						class="form-input"
						required
						autocomplete="current-password"
						placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
					/>
				</div>

				<button type="submit" class="btn btn-primary btn-full btn-lg" style="margin-top: 0.5rem;">
					ç™»å½•
				</button>
			</form>

			<div class="auth-divider"><span>è¿˜æ²¡æœ‰è´¦å·ï¼Ÿ</span></div>

			<div style="text-align: center;">
				<a href="/register" class="btn btn-secondary btn-full">æ³¨å†Œæ–°è´¦å·</a>
			</div>

			<p style="text-align: center; margin-top: 1.25rem; font-size: 0.8rem; color: var(--text-light);">
				<a href="/join-editorial-board">ç”³è¯·åŠ å…¥ç¼–å§”ä¼š</a>
			</p>
		</div>
	</div>
</BaseLayout>

<script>
	function setRole(role: string) {
		const tabs = document.querySelectorAll(".role-tab");
		tabs.forEach((t) => t.classList.remove("active"));
		document.getElementById(`tab-${role}`)?.classList.add("active");
	}
</script>
