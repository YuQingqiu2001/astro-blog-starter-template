---
import BaseLayout from "../layouts/BaseLayout.astro";
import { getSession, getSessionToken } from "../lib/auth";

// If already logged in, redirect
const token = getSessionToken(Astro.request);
const env = Astro.locals.runtime?.env;
if (token && env?.DB) {
	const session = await getSession({ kv: env.SESSIONS_KV, db: env.DB }, token);
	if (session) {
		return Astro.redirect(`/${session.role}`);
	}
}

const error = new URL(Astro.request.url).searchParams.get("error");
const redirect = new URL(Astro.request.url).searchParams.get("redirect") || "";
---

<BaseLayout title="Login - Rubbish Publishing Group">
	<div class="auth-page">
		<div class="auth-card">
			<h1>Sign In</h1>
			<p class="auth-subtitle">Rubbish Publishing Group ‚Äî Manuscript Submission & Review Platform</p>

			{error && (
				<div class="alert alert-error">
					{error === "invalid" ? "Incorrect email or password. Please try again." :
					 error === "unavailable" ? "Service temporarily unavailable. Please try again later." : error}
				</div>
			)}

			<!-- Role tabs (visual only, for UX) -->
			<div class="role-tabs" id="role-tabs">
				<button class="role-tab active" onclick="setRole('author')" type="button" id="tab-author">
					‚úèÔ∏è Author
				</button>
				<button class="role-tab" onclick="setRole('editor')" type="button" id="tab-editor">
					üìã Editor
				</button>
				<button class="role-tab" onclick="setRole('reviewer')" type="button" id="tab-reviewer">
					üîç Reviewer
				</button>
			</div>

			<form action="/api/auth/login" method="post">
				<input type="hidden" name="redirect" value={redirect} />

				<div class="form-group">
					<label class="form-label" for="email">Email Address</label>
					<input
						type="email"
						id="email"
						name="email"
						class="form-input"
						required
						autocomplete="email"
						placeholder="your@email.com"
					/>
				</div>

				<div class="form-group">
					<label class="form-label" for="password">Password</label>
					<input
						type="password"
						id="password"
						name="password"
						class="form-input"
						required
						autocomplete="current-password"
						placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"
					/>
				</div>

				<button type="submit" class="btn btn-primary btn-full btn-lg" style="margin-top: 0.5rem;">
					Sign In
				</button>
			</form>

			<div class="auth-divider"><span>Don't have an account?</span></div>

			<div style="text-align: center;">
				<a href="/register" class="btn btn-secondary btn-full">Create Account</a>
			</div>

			<p style="text-align: center; margin-top: 1.25rem; font-size: 0.8rem; color: var(--text-light);">
				<a href="/join-editorial-board">Apply to join the Editorial Board</a>
			</p>
		</div>
	</div>
</BaseLayout>

<script>
	function setRole(role: string) {
		const tabs = document.querySelectorAll(".role-tab");
		tabs.forEach((t) => t.classList.remove("active"));
		document.getElementById(`tab-${role}`)?.classList.add("active");
	}
</script>
