---
const requestUrl = new URL(Astro.request.url);
const code = requestUrl.searchParams.get("code") || "";
const state = requestUrl.searchParams.get("state") || "";
const orcid = requestUrl.searchParams.get("orcid") || "";
const error = requestUrl.searchParams.get("error") || "";
const errorDescription = requestUrl.searchParams.get("error_description") || "";
const success = !error && !!orcid;
---

<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>ORCID Authorization</title>
		<style>
			body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; padding: 1.2rem; line-height: 1.5; }
			.box { max-width: 520px; margin: 0 auto; border: 1px solid #e5e7eb; border-radius: 10px; padding: 1rem; }
			.ok { color: #166534; }
			.err { color: #991b1b; }
			button { margin-top: 0.8rem; padding: 0.5rem 0.8rem; border-radius: 8px; border: 1px solid #d1d5db; background: #fff; cursor: pointer; }
		</style>
	</head>
	<body>
		<div class="box">
			{success ? (
				<>
					<h1 class="ok">ORCID authorization successful</h1>
					<p>Your ORCID iD has been sent back to the application form. This window will close automatically.</p>
					<p><strong>ORCID iD:</strong> {orcid}</p>
				</>
			) : (
				<>
					<h1 class="err">ORCID authorization failed</h1>
					<p>{errorDescription || "Unable to complete ORCID OAuth. Please check ORCID callback URL and credentials."}</p>
					<p><strong>Error code:</strong> {error || "unknown_error"}</p>
					<button id="send-back">Return to application</button>
				</>
			)}
		</div>

		<script define:vars={{ code, state, orcid, error, errorDescription, success }}>
			const payload = {
				type: "orcid-oauth",
				state,
				orcid,
				code,
				error,
				errorDescription,
			};

			const postBack = () => {
				if (window.opener) {
					window.opener.postMessage(payload, window.location.origin);
				}
			};

			if (success) {
				postBack();
				setTimeout(() => window.close(), 250);
			} else {
				document.getElementById("send-back")?.addEventListener("click", () => {
					postBack();
					window.close();
				});
			}
		</script>
	</body>
</html>
