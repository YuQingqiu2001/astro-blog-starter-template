---
import DashboardLayout from "../../layouts/DashboardLayout.astro";

const user = Astro.locals.user!;
const env = Astro.locals.runtime?.env;

let manuscripts: any[] = [];
let stats = { submitted: 0, under_review: 0, revision: 0, accepted: 0, rejected: 0, published: 0 };

try {
	if (env?.DB) {
		const result = await env.DB.prepare(`
			SELECT m.*, j.name as journal_name
			FROM manuscripts m
			JOIN journals j ON m.journal_id = j.id
			WHERE m.submitter_id = ?
			ORDER BY m.updated_at DESC
		`).bind(user.id).all();
		manuscripts = result.results as any[];

		for (const m of manuscripts) {
			if (m.status === "submitted") stats.submitted++;
			else if (m.status === "under_review") stats.under_review++;
			else if (m.status === "revision_requested" || m.status === "resubmitted") stats.revision++;
			else if (m.status === "accepted") stats.accepted++;
			else if (m.status === "rejected") stats.rejected++;
			else if (m.status === "published") stats.published++;
		}
	}
} catch (e) {
	// DB not available
}

const statusLabel: Record<string, string> = {
	submitted: "å·²æäº¤",
	under_review: "å®¡ç¨¿ä¸­",
	revision_requested: "éœ€ä¿®æ”¹",
	resubmitted: "å·²ä¿®æ”¹æäº¤",
	accepted: "å·²æ¥å—",
	rejected: "å·²æ‹’ç¨¿",
	published: "å·²å‘è¡¨",
};

const statusBadge: Record<string, string> = {
	submitted: "badge-submitted",
	under_review: "badge-under-review",
	revision_requested: "badge-revision",
	resubmitted: "badge-resubmitted",
	accepted: "badge-accepted",
	rejected: "badge-rejected",
	published: "badge-published",
};
---

<DashboardLayout title="æˆ‘çš„ç¨¿ä»¶" activeNav="/author">
	<h1 class="dashboard-page-title">ğŸ“„ æˆ‘çš„ç¨¿ä»¶</h1>

	<!-- Stats -->
	<div class="stats-row">
		<div class="stat-card">
			<div class="number">{stats.submitted}</div>
			<div class="label">å·²æäº¤</div>
		</div>
		<div class="stat-card">
			<div class="number">{stats.under_review}</div>
			<div class="label">å®¡ç¨¿ä¸­</div>
		</div>
		<div class="stat-card">
			<div class="number">{stats.revision}</div>
			<div class="label">éœ€ä¿®æ”¹</div>
		</div>
		<div class="stat-card">
			<div class="number" style="color: var(--green);">{stats.accepted + stats.published}</div>
			<div class="label">å·²æ¥å—/å‘è¡¨</div>
		</div>
	</div>

	<!-- Action -->
	<div style="margin-bottom: 1.5rem; display: flex; justify-content: flex-end;">
		<a href="/author/submit" class="btn btn-primary">âœï¸ æŠ•é€’æ–°ç¨¿ä»¶</a>
	</div>

	<!-- Manuscripts table -->
	{manuscripts.length === 0 ? (
		<div class="alert alert-info">
			æ‚¨è¿˜æ²¡æœ‰æŠ•é€’è¿‡ç¨¿ä»¶ã€‚<a href="/author/submit">ç«‹å³æŠ•é€’æ‚¨çš„ç¬¬ä¸€ç¯‡ç¨¿ä»¶</a>ï¼
		</div>
	) : (
		<table class="manuscript-table">
			<thead>
				<tr>
					<th>ç¨¿ä»¶æ ‡é¢˜</th>
					<th>æœŸåˆŠ</th>
					<th>æŠ•é€’æ—¥æœŸ</th>
					<th>æœ€æ–°çŠ¶æ€</th>
					<th>æ“ä½œ</th>
				</tr>
			</thead>
			<tbody>
				{manuscripts.map((m) => (
					<tr>
						<td class="manuscript-title-cell">
							<a href={`/author/manuscript/${m.id}`}>{m.title}</a>
						</td>
						<td class="text-muted text-sm">{m.journal_name}</td>
						<td class="text-sm text-muted">
							{new Date(m.created_at).toLocaleDateString("zh-CN")}
						</td>
						<td>
							<span class={`badge ${statusBadge[m.status] || "badge-submitted"}`}>
								{statusLabel[m.status] || m.status}
							</span>
						</td>
						<td>
							<div style="display: flex; gap: 0.5rem;">
								<a href={`/author/manuscript/${m.id}`} class="btn btn-sm btn-secondary">
									æŸ¥çœ‹
								</a>
								{m.status === "revision_requested" && (
									<a href={`/author/manuscript/${m.id}?action=revise`} class="btn btn-sm btn-warning">
										æäº¤ä¿®æ”¹
									</a>
								)}
							</div>
						</td>
					</tr>
				))}
			</tbody>
		</table>
	)}
</DashboardLayout>
