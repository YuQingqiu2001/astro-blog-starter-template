---
import DashboardLayout from "../../layouts/DashboardLayout.astro";
import { journals } from "../../data/journals";

const error = new URL(Astro.request.url).searchParams.get("error");
const success = new URL(Astro.request.url).searchParams.get("success");
---

<DashboardLayout title="æŠ•é€’ç¨¿ä»¶" activeNav="/author/submit">
	<h1 class="dashboard-page-title">âœï¸ æŠ•é€’æ–°ç¨¿ä»¶</h1>

	{success && (
		<div class="alert alert-success">
			ç¨¿ä»¶å·²æˆåŠŸæäº¤ï¼æ‚¨å¯ä»¥åœ¨<a href="/author">æˆ‘çš„ç¨¿ä»¶</a>ä¸­æŸ¥çœ‹ç¨¿ä»¶çŠ¶æ€ã€‚
		</div>
	)}

	{error && (
		<div class="alert alert-error">
			{error === "missing_fields" ? "è¯·å¡«å†™æ‰€æœ‰å¿…å¡«å­—æ®µã€‚" :
			 error === "file_too_large" ? "æ–‡ä»¶è¿‡å¤§ï¼Œè¯·ä¸Šä¼ ä¸è¶…è¿‡50MBçš„PDFæ–‡ä»¶ã€‚" :
			 error === "invalid_file" ? "è¯·ä¸Šä¼ PDFæ ¼å¼çš„ç¨¿ä»¶æ–‡ä»¶ã€‚" : error}
		</div>
	)}

	<div style="max-width: 760px;">
		<form action="/api/manuscripts/submit" method="post" enctype="multipart/form-data">
			<div class="card">
				<div class="card-header">
					<h2 style="font-size: 1rem;">åŸºæœ¬ä¿¡æ¯</h2>
				</div>
				<div class="card-body">
					<div class="form-group">
						<label class="form-label" for="journal-id">æŠ•é€’æœŸåˆŠ <span>*</span></label>
						<select name="journal_id" id="journal-id" class="form-select" required>
							<option value="">è¯·é€‰æ‹©ç›®æ ‡æœŸåˆŠ...</option>
							{journals.map((j) => (
								<option value={j.id}>{j.name} - IF: {j.impactFactor}</option>
							))}
						</select>
					</div>

					<div class="form-group">
						<label class="form-label" for="title">ç¨¿ä»¶æ ‡é¢˜ <span>*</span></label>
						<input
							type="text"
							id="title"
							name="title"
							class="form-input"
							required
							placeholder="ç¨¿ä»¶çš„å®Œæ•´æ ‡é¢˜"
						/>
					</div>

					<div class="form-group">
						<label class="form-label" for="authors">ä½œè€…åˆ—è¡¨ <span>*</span></label>
						<input
							type="text"
							id="authors"
							name="authors"
							class="form-input"
							required
							placeholder="ä¾‹å¦‚ï¼šå¼ ä¸‰, æå››, ç‹äº”ï¼ˆå¤šä½ä½œè€…ç”¨é€—å·åˆ†éš”ï¼‰"
						/>
						<p class="form-help">è¯·æŒ‰ç…§è´¡çŒ®åº¦æ’åˆ—ï¼Œé€šè®¯ä½œè€…è¯·åœ¨åå­—ååŠ *</p>
					</div>

					<div class="form-group">
						<label class="form-label" for="keywords">å…³é”®è¯ <span>*</span></label>
						<input
							type="text"
							id="keywords"
							name="keywords"
							class="form-input"
							required
							placeholder="ä¾‹å¦‚ï¼šç„å­¦, é‡å­åŠ›å­¦, è’è°¬æ€§ï¼ˆç”¨é€—å·åˆ†éš”ï¼Œ3-8ä¸ªå…³é”®è¯ï¼‰"
						/>
					</div>
				</div>
			</div>

			<div class="card" style="margin-top: 1rem;">
				<div class="card-header">
					<h2 style="font-size: 1rem;">æ‘˜è¦</h2>
				</div>
				<div class="card-body">
					<div class="form-group" style="margin-bottom: 0;">
						<label class="form-label" for="abstract">æ‘˜è¦ <span>*</span></label>
						<textarea
							id="abstract"
							name="abstract"
							class="form-textarea"
							required
							rows="8"
							placeholder="è¯·æä¾›ä¸è¶…è¿‡300å­—çš„ç ”ç©¶æ‘˜è¦ï¼ŒåŒ…æ‹¬ç ”ç©¶ç›®çš„ã€æ–¹æ³•ã€ä¸»è¦ç»“æœå’Œç»“è®º..."
						></textarea>
						<p class="form-help">å­—æ•°å»ºè®®ï¼š100-300å­—</p>
					</div>
				</div>
			</div>

			<div class="card" style="margin-top: 1rem;">
				<div class="card-header">
					<h2 style="font-size: 1rem;">ç¨¿ä»¶æ–‡ä»¶</h2>
				</div>
				<div class="card-body">
					<div class="form-group" style="margin-bottom: 0;">
						<label class="form-label" for="manuscript">ç¨¿ä»¶æ–‡ä»¶ <span>*</span></label>
						<div class="upload-area" onclick="document.getElementById('manuscript').click()">
							<p style="font-size: 1.5rem; margin-bottom: 0.5rem;">ğŸ“„</p>
							<p>ç‚¹å‡»æ­¤å¤„æˆ–æ‹–æ‹½æ–‡ä»¶ä¸Šä¼ </p>
							<p class="text-xs text-muted" style="margin-top: 0.5rem;">æ”¯æŒ PDF æ ¼å¼ï¼Œæœ€å¤§ 50MB</p>
						</div>
						<input
							type="file"
							id="manuscript"
							name="manuscript"
							accept=".pdf"
							required
							style="display: none;"
							onchange="updateFileName(this)"
						/>
						<p class="form-help" id="manuscript-filename"></p>
					</div>
				</div>
			</div>

			<div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
				<a href="/author" class="btn btn-secondary">å–æ¶ˆ</a>
				<button type="submit" class="btn btn-primary btn-lg">
					æäº¤ç¨¿ä»¶
				</button>
			</div>
		</form>
	</div>
</DashboardLayout>

<script>
	function updateFileName(input: HTMLInputElement) {
		const el = document.getElementById("manuscript-filename")!;
		if (input.files && input.files[0]) {
			const file = input.files[0];
			const sizeMB = (file.size / 1024 / 1024).toFixed(2);
			el.textContent = `å·²é€‰æ‹©ï¼š${file.name}ï¼ˆ${sizeMB} MBï¼‰`;
		}
	}

	// Drag and drop
	const uploadArea = document.querySelector(".upload-area")!;
	uploadArea.addEventListener("dragover", (e) => {
		e.preventDefault();
		uploadArea.classList.add("drag-over");
	});
	uploadArea.addEventListener("dragleave", () => {
		uploadArea.classList.remove("drag-over");
	});
	uploadArea.addEventListener("drop", (e: DragEvent) => {
		e.preventDefault();
		uploadArea.classList.remove("drag-over");
		const input = document.getElementById("manuscript") as HTMLInputElement;
		if (e.dataTransfer?.files?.[0]) {
			const dt = new DataTransfer();
			dt.items.add(e.dataTransfer.files[0]);
			input.files = dt.files;
			updateFileName(input);
		}
	});
</script>
