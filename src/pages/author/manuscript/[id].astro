---
import DashboardLayout from "../../../layouts/DashboardLayout.astro";

const user = Astro.locals.user!;
const env = Astro.locals.runtime?.env;
const id = parseInt(Astro.params.id!);
const action = new URL(Astro.request.url).searchParams.get("action");

let manuscript: any = null;
let reviews: any[] = [];
let decisions: any[] = [];
let revisions: any[] = [];

try {
	if (env?.DB) {
		const mResult = await env.DB.prepare(`
			SELECT m.*, j.name as journal_name
			FROM manuscripts m
			JOIN journals j ON m.journal_id = j.id
			WHERE m.id = ? AND m.submitter_id = ?
		`).bind(id, user.id).first();
		manuscript = mResult;

		if (manuscript) {
			const rResult = await env.DB.prepare(`
				SELECT r.review_r2_key, r.recommendation, r.comments, r.submitted_at
				FROM reviews r
				WHERE r.manuscript_id = ? AND r.status = 'submitted'
			`).bind(id).all();
			reviews = rResult.results as any[];

			const dResult = await env.DB.prepare(`
				SELECT * FROM editorial_decisions WHERE manuscript_id = ? ORDER BY created_at DESC
			`).bind(id).all();
			decisions = dResult.results as any[];

			const revResult = await env.DB.prepare(`
				SELECT * FROM manuscript_revisions WHERE manuscript_id = ? ORDER BY version DESC
			`).bind(id).all();
			revisions = revResult.results as any[];
		}
	}
} catch (e) {
	// DB not available
}

if (!manuscript && env?.DB) {
	return Astro.redirect("/author");
}

const statusLabel: Record<string, string> = {
	submitted: "å·²æäº¤ï¼Œç­‰å¾…ç¼–è¾‘å¤„ç†",
	under_review: "å®¡ç¨¿ä¸­",
	revision_requested: "ç¼–è¾‘è¦æ±‚ä¿®æ”¹",
	resubmitted: "å·²æäº¤ä¿®æ”¹ç¨¿",
	accepted: "æ­å–œï¼ç¨¿ä»¶å·²æ¥å—",
	rejected: "ç¨¿ä»¶å·²æ‹’ç¨¿",
	published: "ç¨¿ä»¶å·²æ­£å¼å‘è¡¨",
};

const recommendationLabel: Record<string, string> = {
	accept: "æ¥å—",
	minor_revision: "å°ä¿®",
	major_revision: "å¤§ä¿®",
	reject: "æ‹’ç¨¿",
};

// Fallback for demo
if (!manuscript) {
	manuscript = {
		id,
		title: "ç¤ºä¾‹ç¨¿ä»¶ï¼šæ°´çš„æ¹¿æ¶¦æ€§ç ”ç©¶",
		abstract: "æœ¬ç ”ç©¶ç³»ç»Ÿåœ°ç ”ç©¶äº†æ°´çš„æ¹¿æ¶¦ç‰¹æ€§...",
		authors: "å¼ ä¼Ÿ, ææ˜",
		keywords: "æ°´, æ¹¿æ¶¦",
		journal_name: "ç„å­¦å‰æ²¿",
		status: "revision_requested",
		created_at: new Date().toISOString(),
		updated_at: new Date().toISOString(),
		editor_comment: "å®¡ç¨¿äººå¯¹æ–¹æ³•éƒ¨åˆ†æå‡ºäº†ä¸€äº›å»ºè®®ï¼Œè¯·å‚è€ƒå®¡ç¨¿æ„è§è¿›è¡Œä¿®æ”¹ã€‚",
	};
}
---

<DashboardLayout title={`ç¨¿ä»¶è¯¦æƒ…`} activeNav="/author">
	<div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem;">
		<a href="/author" class="btn btn-sm btn-secondary">â† è¿”å›</a>
		<h1 class="dashboard-page-title" style="margin-bottom: 0;">ç¨¿ä»¶è¯¦æƒ…</h1>
	</div>

	<!-- Manuscript Info -->
	<div class="card" style="margin-bottom: 1.25rem;">
		<div class="card-header" style="display: flex; justify-content: space-between; align-items: center;">
			<h2 style="font-size: 1rem;">åŸºæœ¬ä¿¡æ¯</h2>
			<span class={`badge badge-${manuscript.status?.replace(/_/g, "-") || "submitted"}`}>
				{statusLabel[manuscript.status] || manuscript.status}
			</span>
		</div>
		<div class="card-body">
			<h3 style="font-size: 1.1rem; margin-bottom: 0.5rem;">{manuscript.title}</h3>
			<p class="text-muted text-sm" style="margin-bottom: 0.75rem;">
				ä½œè€…ï¼š{manuscript.authors}
			</p>
			<p class="text-muted text-sm" style="margin-bottom: 0.75rem;">
				æœŸåˆŠï¼š{manuscript.journal_name} Â·
				æŠ•é€’æ—¥æœŸï¼š{new Date(manuscript.created_at).toLocaleDateString("zh-CN")}
			</p>
			{manuscript.keywords && (
				<p class="text-sm" style="margin-bottom: 0.75rem;">
					å…³é”®è¯ï¼š<span class="text-muted">{manuscript.keywords}</span>
				</p>
			)}
			{manuscript.abstract && (
				<div style="background: var(--bg-sidebar); padding: 1rem; border-radius: var(--radius-sm); margin-top: 0.75rem;">
					<p class="text-sm text-muted" style="font-style: italic;">{manuscript.abstract}</p>
				</div>
			)}
		</div>
	</div>

	{/* Editor comments */}
	{manuscript.editor_comment && (
		<div class="card" style="margin-bottom: 1.25rem; border-left: 4px solid var(--orange);">
			<div class="card-body">
				<h3 style="font-size: 0.9rem; color: var(--orange); margin-bottom: 0.5rem;">ğŸ“¨ ç¼–è¾‘æ„è§</h3>
				<p class="text-sm">{manuscript.editor_comment}</p>
			</div>
		</div>
	)}

	{/* Review opinions (available after decision) */}
	{reviews.length > 0 && (
		<div class="card" style="margin-bottom: 1.25rem;">
			<div class="card-header">
				<h3 style="font-size: 1rem;">å®¡ç¨¿æ„è§</h3>
			</div>
			<div class="card-body">
				{reviews.map((review, i) => (
					<div style={`padding: 1rem 0; ${i > 0 ? "border-top: 1px solid var(--border);" : ""}`}>
						<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
							<span class="text-sm font-bold">å®¡ç¨¿äºº {String.fromCharCode(65 + i)}</span>
							{review.recommendation && (
								<span class="badge badge-under-review">
									å»ºè®®ï¼š{recommendationLabel[review.recommendation] || review.recommendation}
								</span>
							)}
						</div>
						{review.comments && <p class="text-sm text-muted">{review.comments}</p>}
						{review.review_r2_key && (
							<a
								href={`/api/download/${encodeURIComponent(review.review_r2_key)}`}
								class="btn btn-sm btn-secondary"
								style="margin-top: 0.5rem;"
							>
								ä¸‹è½½è¯¦ç»†å®¡ç¨¿æ„è§
							</a>
						)}
					</div>
				))}
			</div>
		</div>
	)}

	{/* Revision history */}
	{revisions.length > 0 && (
		<div class="card" style="margin-bottom: 1.25rem;">
			<div class="card-header">
				<h3 style="font-size: 1rem;">ä¿®æ”¹å†å²</h3>
			</div>
			<div class="card-body">
				{revisions.map((rev) => (
					<div style="display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; border-bottom: 1px solid var(--border);">
						<span class="text-sm">ç¬¬ {rev.version} ç‰ˆä¿®æ”¹ç¨¿</span>
						<div style="display: flex; gap: 0.5rem; align-items: center;">
							<span class="text-xs text-muted">{new Date(rev.created_at).toLocaleDateString("zh-CN")}</span>
							<a href={`/api/download/${encodeURIComponent(rev.r2_key)}`} class="btn btn-sm btn-secondary">
								ä¸‹è½½
							</a>
						</div>
					</div>
				))}
			</div>
		</div>
	)}

	{/* Revise action */}
	{(manuscript.status === "revision_requested") && (
		<div class="card" style="border-color: var(--orange);">
			<div class="card-header" style="background: #fff3e0;">
				<h3 style="font-size: 1rem; color: var(--orange);">ğŸ“ æäº¤ä¿®æ”¹ç¨¿</h3>
			</div>
			<div class="card-body">
				<p class="text-sm text-muted" style="margin-bottom: 1.25rem;">
					è¯·æ ¹æ®å®¡ç¨¿æ„è§ä¿®æ”¹æ‚¨çš„ç¨¿ä»¶ï¼Œå¹¶ä¸Šä¼ ä¿®æ”¹ç¨¿å’Œå›åº”ä¿¡ï¼ˆé€ä¸€å›åº”æ¯æ¡å®¡ç¨¿æ„è§ï¼‰ã€‚
				</p>
				<form action={`/api/manuscripts/${id}/revise`} method="post" enctype="multipart/form-data">
					<div class="form-group">
						<label class="form-label">ä¿®æ”¹ç¨¿ (PDF) <span>*</span></label>
						<div class="upload-area" onclick="document.getElementById('revised').click()">
							<p>ä¸Šä¼ ä¿®æ”¹åçš„ç¨¿ä»¶</p>
						</div>
						<input type="file" id="revised" name="manuscript" accept=".pdf" required style="display: none;" />
					</div>
					<div class="form-group">
						<label class="form-label">å›åº”ä¿¡ï¼ˆå›åº”å®¡ç¨¿æ„è§ï¼‰</label>
						<textarea
							name="response_letter"
							class="form-textarea"
							rows="6"
							placeholder="é€ä¸€å›åº”æ¯ä½å®¡ç¨¿äººçš„æ„è§ï¼Œè¯´æ˜å¦‚ä½•ä¿®æ”¹æˆ–ä¸ºä½•ä¸åŒæ„æŸäº›å»ºè®®..."
						></textarea>
					</div>
					<button type="submit" class="btn btn-warning">æäº¤ä¿®æ”¹ç¨¿</button>
				</form>
			</div>
		</div>
	)}
</DashboardLayout>
