---
import DashboardLayout from "../../../layouts/DashboardLayout.astro";

const user = Astro.locals.user!;
const env = Astro.locals.runtime?.env;
const id = parseInt(Astro.params.id!);

let review: any = null;
let manuscript: any = null;

try {
	if (env?.DB) {
		const reviewResult = await env.DB.prepare(`
			SELECT r.*, m.title, m.authors, m.abstract, m.keywords, m.r2_key, j.name as journal_name
			FROM reviews r
			JOIN manuscripts m ON r.manuscript_id = m.id
			JOIN journals j ON m.journal_id = j.id
			WHERE r.manuscript_id = ? AND r.reviewer_id = ?
		`).bind(id, user.id).first();
		review = reviewResult;

		// Mark as in progress if just assigned
		if (review?.status === "assigned" && env?.DB) {
			await env.DB.prepare(
				"UPDATE reviews SET status = 'in_progress' WHERE manuscript_id = ? AND reviewer_id = ?"
			).bind(id, user.id).run();
			review.status = "in_progress";
		}
	}
} catch (e) {
	// DB not available
}

if (!review && env?.DB) {
	return Astro.redirect("/reviewer");
}

// Demo fallback
if (!review) {
	review = {
		manuscript_id: id,
		title: "ç¤ºä¾‹ç¨¿ä»¶ï¼šæ°´çš„æ¹¿æ¶¦æ€§ç ”ç©¶",
		authors: "å¼ ä¼Ÿ, ææ˜",
		abstract: "æœ¬ç ”ç©¶ç³»ç»Ÿåœ°ç ”ç©¶äº†æ°´çš„æ¹¿æ¶¦ç‰¹æ€§...",
		keywords: "æ°´, æ¹¿æ¶¦, ç³»ç»Ÿç»¼è¿°",
		journal_name: "ç„å­¦å‰æ²¿",
		status: "in_progress",
		r2_key: null,
	};
}
---

<DashboardLayout title="å®¡ç¨¿" activeNav="/reviewer">
	<div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1.5rem;">
		<a href="/reviewer" class="btn btn-sm btn-secondary">â† è¿”å›</a>
		<h1 class="dashboard-page-title" style="margin-bottom: 0;">å®¡ç¨¿æ„è§</h1>
	</div>

	<!-- Manuscript Info -->
	<div class="card" style="margin-bottom: 1.25rem;">
		<div class="card-header">
			<h2 style="font-size: 1rem;">ç¨¿ä»¶ä¿¡æ¯ï¼ˆåŒç›²åŒ¿åï¼‰</h2>
		</div>
		<div class="card-body">
			<h3 style="font-size: 1.1rem; margin-bottom: 0.5rem;">{review.title}</h3>
			<p class="text-sm text-muted" style="margin-bottom: 0.5rem;">
				æœŸåˆŠï¼š{review.journal_name}
			</p>
			{review.keywords && (
				<p class="text-sm" style="margin-bottom: 0.75rem;">
					å…³é”®è¯ï¼š<span class="text-muted">{review.keywords}</span>
				</p>
			)}
			{review.abstract && (
				<div style="background: var(--bg-sidebar); padding: 1rem; border-radius: var(--radius-sm); margin-top: 0.75rem;">
					<p class="text-xs text-muted" style="font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem;">æ‘˜è¦</p>
					<p class="text-sm">{review.abstract}</p>
				</div>
			)}
			{review.r2_key && (
				<div style="margin-top: 1rem;">
					<a
						href={`/api/download/${encodeURIComponent(review.r2_key)}`}
						class="btn btn-primary"
					>
						ğŸ“„ ä¸‹è½½å®Œæ•´ç¨¿ä»¶
					</a>
				</div>
			)}
		</div>
	</div>

	<!-- Review Form -->
	{review.status !== "submitted" ? (
		<div class="card">
			<div class="card-header">
				<h2 style="font-size: 1rem;">æäº¤å®¡ç¨¿æ„è§</h2>
			</div>
			<div class="card-body">
				<form action={`/api/manuscripts/${id}/review`} method="post" enctype="multipart/form-data">
					<div class="form-group">
						<label class="form-label">æ¨èå†³å®š <span>*</span></label>
						<div style="display: flex; gap: 0.75rem; flex-wrap: wrap; margin-top: 0.5rem;">
							{[
								{ value: "accept", label: "æ¥å—", badge: "badge-accepted" },
								{ value: "minor_revision", label: "å°ä¿®åæ¥å—", badge: "badge-resubmitted" },
								{ value: "major_revision", label: "å¤§ä¿®åé‡å®¡", badge: "badge-revision" },
								{ value: "reject", label: "æ‹’ç¨¿", badge: "badge-rejected" },
							].map((opt) => (
								<label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
									<input type="radio" name="recommendation" value={opt.value} required />
									<span class={`badge ${opt.badge}`}>{opt.label}</span>
								</label>
							))}
						</div>
					</div>

					<div class="form-group">
						<label class="form-label">å®¡ç¨¿æ„è§ï¼ˆç»™ä½œè€…ï¼‰<span>*</span></label>
						<textarea
							name="comments"
							class="form-textarea"
							rows="10"
							required
							placeholder="è¯·è¯¦ç»†è¯´æ˜æ‚¨çš„å®¡ç¨¿æ„è§ï¼ŒåŒ…æ‹¬ï¼š
1. ç¨¿ä»¶çš„ä¸»è¦è´¡çŒ®å’Œåˆ›æ–°æ€§
2. ç ”ç©¶æ–¹æ³•çš„åˆç†æ€§
3. ç»“æœå’Œç»“è®ºçš„å¯é æ€§
4. æ–‡å­—å’Œå†™ä½œè´¨é‡
5. å…·ä½“ä¿®æ”¹å»ºè®®ï¼ˆå¦‚æœ‰ï¼‰

æ³¨ï¼šæœ¬éƒ¨åˆ†å°†åœ¨å»é™¤å®¡ç¨¿äººä¿¡æ¯åå‘é€ç»™ä½œè€…ã€‚"
						></textarea>
					</div>

					<div class="form-group">
						<label class="form-label">è¯¦ç»†å®¡ç¨¿æŠ¥å‘Š (PDF, å¯é€‰)</label>
						<div class="upload-area" onclick="document.getElementById('review-file').click()">
							<p>ä¸Šä¼ è¯¦ç»†å®¡ç¨¿æŠ¥å‘Šï¼ˆå¯é€‰ï¼‰</p>
							<p class="text-xs text-muted" style="margin-top: 0.25rem;">PDFæ ¼å¼ï¼Œæœ€å¤§20MB</p>
						</div>
						<input type="file" id="review-file" name="review_file" accept=".pdf" style="display: none;" />
					</div>

					<div style="display: flex; gap: 1rem; margin-top: 0.5rem;">
						<button type="submit" class="btn btn-primary btn-lg">
							æäº¤å®¡ç¨¿æ„è§
						</button>
						<a href="/reviewer" class="btn btn-secondary">ç¨åå†å®¡</a>
					</div>
				</form>
			</div>
		</div>
	) : (
		<div class="alert alert-success">
			æ‚¨å·²æäº¤äº†æœ¬ç¨¿ä»¶çš„å®¡ç¨¿æ„è§ã€‚æ„Ÿè°¢æ‚¨å¯¹å­¦æœ¯å‡ºç‰ˆçš„è´¡çŒ®ï¼
		</div>
	)}
</DashboardLayout>
