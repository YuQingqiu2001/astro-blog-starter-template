---
import BaseLayout from "../layouts/BaseLayout.astro";
import { journals } from "../data/journals";

const error = new URL(Astro.request.url).searchParams.get("error");
---

<BaseLayout title="æ³¨å†Œ - ç„å­¦å‰æ²¿æœŸåˆŠç¾¤">
	<div class="auth-page" style="align-items: flex-start; padding-top: 3rem;">
		<div class="auth-card" style="max-width: 520px;">
			<h1>æ³¨å†Œè´¦å·</h1>
			<p class="auth-subtitle">åŠ å…¥ç„å­¦å‰æ²¿æœŸåˆŠæŠ•ç¨¿å¹³å°</p>

			{error && (
				<div class="alert alert-error" id="error-msg">
					{error === "email_taken" ? "è¯¥é‚®ç®±å·²è¢«æ³¨å†Œï¼Œè¯·ç›´æ¥ç™»å½•ã€‚" :
					 error === "code_invalid" ? "éªŒè¯ç é”™è¯¯æˆ–å·²è¿‡æœŸï¼Œè¯·é‡æ–°è·å–ã€‚" :
					 error === "weak_password" ? "å¯†ç å¼ºåº¦ä¸è¶³ï¼Œè¯·è‡³å°‘ä½¿ç”¨8ä½å­—ç¬¦ã€‚" : error}
				</div>
			)}

			<!-- Step 1: Email Verification -->
			<div id="step1">
				<h3 style="font-size: 1rem; margin-bottom: 1rem; color: var(--text-secondary);">æ­¥éª¤ 1/2ï¼šéªŒè¯é‚®ç®±</h3>

				<div class="form-group">
					<label class="form-label" for="verify-email">é‚®ç®±åœ°å€ <span>*</span></label>
					<div class="verification-group">
						<input
							type="email"
							id="verify-email"
							class="form-input"
							placeholder="your@email.com"
							autocomplete="email"
						/>
						<button
							type="button"
							class="btn btn-secondary"
							id="send-code-btn"
							onclick="sendVerificationCode()"
						>
							è·å–éªŒè¯ç 
						</button>
					</div>
				</div>

				<div class="form-group">
					<label class="form-label" for="verify-code">éªŒè¯ç  <span>*</span></label>
					<input
						type="text"
						id="verify-code"
						class="form-input"
						placeholder="6ä½éªŒè¯ç "
						maxlength="6"
						inputmode="numeric"
					/>
					<p class="form-help" id="code-status"></p>
				</div>

				<button type="button" class="btn btn-primary btn-full" onclick="verifyAndNext()">
					ä¸‹ä¸€æ­¥
				</button>
			</div>

			<!-- Step 2: Account Info -->
			<div id="step2" style="display: none;">
				<h3 style="font-size: 1rem; margin-bottom: 1rem; color: var(--text-secondary);">æ­¥éª¤ 2/2ï¼šå¡«å†™è´¦å·ä¿¡æ¯</h3>

				<form action="/api/auth/register" method="post" id="register-form">
					<input type="hidden" name="email" id="form-email" />
					<input type="hidden" name="code" id="form-code" />

					<div class="form-group">
						<label class="form-label">è´¦å·ç±»å‹ <span>*</span></label>
						<div class="role-tabs" style="margin-bottom: 0;">
							<button class="role-tab active" type="button" onclick="setRole('author')" id="role-author">
								âœï¸ ä½œè€…
							</button>
							<button class="role-tab" type="button" onclick="setRole('editor')" id="role-editor">
								ğŸ“‹ ç¼–è¾‘
							</button>
							<button class="role-tab" type="button" onclick="setRole('reviewer')" id="role-reviewer">
								ğŸ” å®¡ç¨¿äºº
							</button>
						</div>
						<input type="hidden" name="role" id="role-input" value="author" />
						<p class="form-help" style="margin-top: 0.5rem;">ç¼–è¾‘å’Œå®¡ç¨¿äººè´¦å·éœ€å…³è”æœŸåˆŠï¼Œå¹¶ç”±ç°æœ‰ç¼–è¾‘å®¡æ ¸ã€‚</p>
					</div>

					<div id="journal-select-group" style="display: none;" class="form-group">
						<label class="form-label" for="journal-id">å…³è”æœŸåˆŠ <span>*</span></label>
						<select name="journal_id" id="journal-id" class="form-select">
							<option value="">è¯·é€‰æ‹©æœŸåˆŠ...</option>
							{journals.map((j) => (
								<option value={j.id}>{j.name} ({j.nameEn})</option>
							))}
						</select>
					</div>

					<div class="form-group">
						<label class="form-label" for="name">å§“å <span>*</span></label>
						<input
							type="text"
							id="name"
							name="name"
							class="form-input"
							required
							placeholder="çœŸå®å§“å"
						/>
					</div>

					<div class="form-group">
						<label class="form-label" for="affiliation">æ‰€å±æœºæ„</label>
						<input
							type="text"
							id="affiliation"
							name="affiliation"
							class="form-input"
							placeholder="å¤§å­¦/ç ”ç©¶æ‰€/å…¬å¸"
						/>
					</div>

					<div class="form-group">
						<label class="form-label" for="password">å¯†ç  <span>*</span></label>
						<input
							type="password"
							id="password"
							name="password"
							class="form-input"
							required
							minlength="8"
							placeholder="è‡³å°‘8ä½å­—ç¬¦"
							autocomplete="new-password"
						/>
					</div>

					<div class="form-group">
						<label class="form-label" for="password2">ç¡®è®¤å¯†ç  <span>*</span></label>
						<input
							type="password"
							id="password2"
							name="password2"
							class="form-input"
							required
							placeholder="å†æ¬¡è¾“å…¥å¯†ç "
							autocomplete="new-password"
						/>
					</div>

					<button type="submit" class="btn btn-primary btn-full btn-lg">
						æ³¨å†Œè´¦å·
					</button>
				</form>
			</div>

			<div class="auth-divider"><span>å·²æœ‰è´¦å·ï¼Ÿ</span></div>
			<a href="/login" class="btn btn-secondary btn-full">è¿”å›ç™»å½•</a>
		</div>
	</div>
</BaseLayout>

<script>
	let verifiedEmail = "";

	async function sendVerificationCode() {
		const emailInput = document.getElementById("verify-email") as HTMLInputElement;
		const email = emailInput.value.trim();
		const btn = document.getElementById("send-code-btn") as HTMLButtonElement;
		const status = document.getElementById("code-status")!;

		if (!email || !email.includes("@")) {
			status.textContent = "è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±åœ°å€";
			status.style.color = "var(--accent)";
			return;
		}

		btn.disabled = true;
		btn.textContent = "å‘é€ä¸­...";
		status.textContent = "";

		try {
			const resp = await fetch("/api/auth/send-code", {
				method: "POST",
				headers: { "Content-Type": "application/json" },
				body: JSON.stringify({ email }),
			});
			const data = await resp.json() as { success?: boolean; error?: string };

			if (data.success) {
				status.textContent = "éªŒè¯ç å·²å‘é€è‡³æ‚¨çš„é‚®ç®±ï¼Œè¯·æŸ¥æ”¶ï¼ˆæœ‰æ•ˆæœŸ10åˆ†é’Ÿï¼‰";
				status.style.color = "var(--green)";
				// Countdown
				let countdown = 60;
				const interval = setInterval(() => {
					btn.textContent = `${countdown}s åé‡è¯•`;
					countdown--;
					if (countdown < 0) {
						clearInterval(interval);
						btn.disabled = false;
						btn.textContent = "é‡æ–°è·å–";
					}
				}, 1000);
			} else {
				status.textContent = data.error || "å‘é€å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•";
				status.style.color = "var(--accent)";
				btn.disabled = false;
				btn.textContent = "è·å–éªŒè¯ç ";
			}
		} catch {
			status.textContent = "ç½‘ç»œé”™è¯¯ï¼Œè¯·ç¨åé‡è¯•";
			status.style.color = "var(--accent)";
			btn.disabled = false;
			btn.textContent = "è·å–éªŒè¯ç ";
		}
	}

	async function verifyAndNext() {
		const email = (document.getElementById("verify-email") as HTMLInputElement).value.trim();
		const code = (document.getElementById("verify-code") as HTMLInputElement).value.trim();
		const status = document.getElementById("code-status")!;

		if (!email || !code) {
			status.textContent = "è¯·å¡«å†™é‚®ç®±å’ŒéªŒè¯ç ";
			status.style.color = "var(--accent)";
			return;
		}

		try {
			const resp = await fetch("/api/auth/verify-code", {
				method: "POST",
				headers: { "Content-Type": "application/json" },
				body: JSON.stringify({ email, code }),
			});
			const data = await resp.json() as { valid?: boolean; error?: string };

			if (data.valid) {
				verifiedEmail = email;
				(document.getElementById("form-email") as HTMLInputElement).value = email;
				(document.getElementById("form-code") as HTMLInputElement).value = code;
				(document.getElementById("step1") as HTMLElement).style.display = "none";
				(document.getElementById("step2") as HTMLElement).style.display = "block";
			} else {
				status.textContent = "éªŒè¯ç é”™è¯¯æˆ–å·²è¿‡æœŸï¼Œè¯·é‡æ–°è·å–";
				status.style.color = "var(--accent)";
			}
		} catch {
			status.textContent = "éªŒè¯å¤±è´¥ï¼Œè¯·é‡è¯•";
			status.style.color = "var(--accent)";
		}
	}

	function setRole(role: string) {
		document.querySelectorAll(".role-tab").forEach((t) => t.classList.remove("active"));
		document.getElementById(`role-${role}`)?.classList.add("active");
		(document.getElementById("role-input") as HTMLInputElement).value = role;
		const jGroup = document.getElementById("journal-select-group")!;
		jGroup.style.display = role !== "author" ? "block" : "none";
	}
</script>
