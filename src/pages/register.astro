---
import BaseLayout from "../layouts/BaseLayout.astro";
import { journals } from "../data/journals";

const error = new URL(Astro.request.url).searchParams.get("error");
---

<BaseLayout title="Register - Rubbish Publishing Group">
	<div class="auth-page" style="align-items: flex-start; padding-top: 3rem;">
		<div class="auth-card" style="max-width: 560px;">
			<h1>Create Account</h1>
			<p class="auth-subtitle">Join the Rubbish Publishing Group submission platform</p>

			{error && (
				<div class="alert alert-error" id="error-msg">
					{error === "email_taken" ? "This email is already registered. Please login." :
					 error === "weak_password" ? "Password too short. Please use at least 8 characters." :
					 error === "missing_fields" ? "Please fill in all required fields." :
					 error === "missing_journal" ? "Editor/reviewer account must select an associated journal." :
					 error === "password_mismatch" ? "Passwords do not match." :
					 error === "invalid_role" ? "Invalid account role." :
					 error === "invalid_input" ? "Input is too long or invalid." :
					 error === "captcha_failed" ? "Human verification failed. Please answer the challenge question." :
					 error === "service_unavailable" ? "Service temporarily unavailable. Please try again later." :
					 error === "server_error" ? "Server error. Please try again later." : error}
				</div>
			)}

			<form action="/api/auth/register" method="post" id="register-form">
				<div class="form-group">
					<label class="form-label">Account Type <span>*</span></label>
					<div class="role-tabs" style="margin-bottom: 0;">
						<button class="role-tab active" type="button" onclick="setRole('author')" id="role-author">
							‚úèÔ∏è Author
						</button>
						<button class="role-tab" type="button" onclick="setRole('editor')" id="role-editor">
							üìã Editor
						</button>
						<button class="role-tab" type="button" onclick="setRole('reviewer')" id="role-reviewer">
							üîç Reviewer
						</button>
					</div>
					<input type="hidden" name="role" id="role-input" value="author" />
					<p class="form-help" style="margin-top: 0.5rem;">Editor and reviewer accounts require journal affiliation and approval from existing editors.</p>
				</div>

				<div id="journal-select-group" style="display: none;" class="form-group">
					<label class="form-label" for="journal-id">Associated Journal <span>*</span></label>
					<select name="journal_id" id="journal-id" class="form-select">
						<option value="">Select a journal...</option>
						{journals.map((j) => (
							<option value={j.id}>{j.name}</option>
						))}
					</select>
				</div>

				<div class="form-group">
					<label class="form-label" for="email">Email Address <span>*</span></label>
					<input type="email" id="email" name="email" class="form-input" required autocomplete="email" placeholder="your@email.com" />
				</div>

				<div class="form-group">
					<label class="form-label" for="name">Full Name <span>*</span></label>
					<input type="text" id="name" name="name" class="form-input" required placeholder="Your full name" />
				</div>

				<div class="form-group">
					<label class="form-label" for="affiliation">Institution / Affiliation</label>
					<input type="text" id="affiliation" name="affiliation" class="form-input" placeholder="University / Research Institute / Company" />
				</div>

				<div class="form-group">
					<label class="form-label" for="password">Password <span>*</span></label>
					<input
						type="password"
						id="password"
						name="password"
						class="form-input"
						required
						minlength="8"
						placeholder="At least 8 characters"
						autocomplete="new-password"
						oninput="checkPasswordStrength(this.value)"
					/>
					<div id="password-strength" style="margin-top: 0.25rem; font-size: 0.8rem;"></div>
				</div>

				<div class="form-group">
					<label class="form-label" for="password2">Confirm Password <span>*</span></label>
					<input
						type="password"
						id="password2"
						name="password2"
						class="form-input"
						required
						placeholder="Re-enter your password"
						autocomplete="new-password"
						oninput="checkPasswordMatch()"
					/>
					<div id="password-match" style="margin-top: 0.25rem; font-size: 0.8rem;"></div>
				</div>

				<div class="form-group">
					<label class="form-label" for="captcha-answer">Human Verification <span>*</span></label>
					<div style="display:flex; gap:0.5rem; align-items:center; margin-bottom:0.5rem;">
						<strong id="captcha-question">Loading challenge...</strong>
						<button type="button" class="btn btn-sm btn-secondary" onclick="regenCaptcha()">‚Üª Refresh</button>
					</div>
					<input type="hidden" name="captcha_expected" id="captcha-expected" />
					<input type="text" id="captcha-answer" name="captcha_answer" class="form-input" required placeholder="Enter answer" inputmode="numeric" />
					<p class="form-help">Please solve the math question to verify you are human.</p>
				</div>

				<button type="submit" class="btn btn-primary btn-full btn-lg" id="submit-btn">
					Create Account
				</button>
			</form>

			<div class="auth-divider"><span>Already have an account?</span></div>
			<a href="/login" class="btn btn-secondary btn-full">Back to Login</a>
		</div>
	</div>
</BaseLayout>

<script>
	function setRole(role) {
		document.querySelectorAll(".role-tab").forEach((t) => t.classList.remove("active"));
		document.getElementById(`role-${role}`)?.classList.add("active");
		document.getElementById("role-input").value = role;
		const jGroup = document.getElementById("journal-select-group");
		const journalSelect = document.getElementById("journal-id");
		const requireJournal = role !== "author";
		jGroup.style.display = requireJournal ? "block" : "none";
		journalSelect.required = requireJournal;
		if (!requireJournal) journalSelect.value = "";
	}

	function regenCaptcha() {
		const a = Math.floor(Math.random() * 8) + 2;
		const b = Math.floor(Math.random() * 8) + 2;
		document.getElementById("captcha-question").textContent = `${a} + ${b} = ?`;
		document.getElementById("captcha-expected").value = String(a + b);
		document.getElementById("captcha-answer").value = "";
	}

	function checkPasswordStrength(password) {
		const el = document.getElementById("password-strength");
		if (!password) { el.textContent = ""; return; }
		if (password.length < 8) {
			el.textContent = "Too short (min 8 characters)";
			el.style.color = "var(--accent)";
		} else if (password.length < 12) {
			el.textContent = "Acceptable";
			el.style.color = "#E65100";
		} else {
			el.textContent = "Strong";
			el.style.color = "var(--green)";
		}
		checkPasswordMatch();
	}

	function checkPasswordMatch() {
		const p1 = document.getElementById("password").value;
		const p2 = document.getElementById("password2").value;
		const el = document.getElementById("password-match");
		if (!p2) { el.textContent = ""; return; }
		if (p1 === p2) {
			el.textContent = "Passwords match";
			el.style.color = "var(--green)";
		} else {
			el.textContent = "Passwords do not match";
			el.style.color = "var(--accent)";
		}
	}

	document.getElementById("register-form")?.addEventListener("submit", (e) => {
		const p1 = document.getElementById("password").value;
		const p2 = document.getElementById("password2").value;
		const expected = document.getElementById("captcha-expected").value;
		const answer = document.getElementById("captcha-answer").value.trim();
		if (p1 !== p2) {
			e.preventDefault();
			document.getElementById("password-match").textContent = "Passwords do not match";
			document.getElementById("password-match").style.color = "var(--accent)";
			return;
		}
		if (!answer || answer !== expected) {
			e.preventDefault();
			alert("Human verification failed. Please solve the math question.");
			regenCaptcha();
		}
	});

	regenCaptcha();
</script>
