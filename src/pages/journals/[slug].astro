---
import BaseLayout from "../../layouts/BaseLayout.astro";
import { journals, getJournalBySlug } from "../../data/journals";
import { editorialBoard } from "../../data/editorial-board";

const { slug } = Astro.params;
const journal = getJournalBySlug(slug!);

if (!journal) {
	return Astro.redirect("/journals");
}

const tab = new URL(Astro.request.url).searchParams.get("tab") || "articles";

// Fetch editorial board and articles from D1
let boardMembers: any[] = [];
let articles: any[] = [];

try {
	const env = Astro.locals.runtime?.env;
	if (env?.DB) {
		// Show all RPG editorial board members on every journal page
		const boardResult = await env.DB.prepare(`
			SELECT eb.*, u.name, u.email, u.affiliation, u.bio, u.orcid
			FROM editorial_board eb
			JOIN users u ON eb.user_id = u.id
			ORDER BY eb.is_editor_in_chief DESC, eb.display_order ASC, u.name ASC
		`).all();
		boardMembers = boardResult.results as any[];

		const articlesResult = await env.DB.prepare(`
			SELECT pa.*
			FROM published_articles pa
			WHERE pa.journal_id = ?
			ORDER BY pa.published_at DESC
			LIMIT 20
		`).bind(journal.id).all();
		articles = articlesResult.results as any[];
	}
} catch (e) {
	// Fallback to sample data
}

// Fallback to static editorial board data if DB is empty
const displayBoard = boardMembers.length > 0 ? boardMembers : editorialBoard;

// Sample articles for this journal if none in DB
const sampleArticles = [
	{
		id: 1,
		title: "Water Is Wet: A Systematic Review and Meta-Analysis",
		abstract: "We present a comprehensive systematic review of literature on the hypothesis that water is wet. Through meta-analysis of 4,721 papers, we confirm with 95% CI that water exhibits wetness at standard temperature and pressure (p<0.001).",
		authors: "Zhang W., Li M., Wang F.",
		doi: "10.0000/RUB.2024.001",
		volume: 1,
		issue: 1,
		published_at: new Date(Date.now() - 30 * 86400000).toISOString(),
	},
	{
		id: 2,
		title: "Correlation Between Peer Review Turnaround Time and Author Emotional Collapse",
		abstract: "Through text analysis of 7,823 rejection letters, we find that each additional month of review delay increases the frequency of resignation-related language by approximately 34% (p<0.001).",
		authors: "Qian B., Sun R.",
		doi: "10.0000/RUB.2024.002",
		volume: 1,
		issue: 1,
		published_at: new Date(Date.now() - 20 * 86400000).toISOString(),
	},
];

const displayArticles = articles.length > 0 ? articles : sampleArticles;
---

<BaseLayout
	title={`${journal.name} - Rubbish Publishing Group`}
	description={journal.description}
>
	<!-- Journal Hero -->
	<div class="journal-hero" style={`background: linear-gradient(135deg, ${journal.color}dd, ${journal.color}88)`}>
		<div class="container">
			<div class="journal-hero-inner">
				<div
					class="journal-hero-cover"
					style={`background: rgba(0,0,0,0.2); border: 2px solid rgba(255,255,255,0.2); overflow:hidden; padding:0;`}
				>
					{journal.coverImage ? (
						<img src={journal.coverImage} alt={journal.name} style="width:100%;height:100%;object-fit:cover;" />
					) : (
						journal.name.charAt(0)
					)}
				</div>
				<div style="flex: 1;">
					<h1>{journal.name}</h1>
					<p class="en-title">{journal.nameEn}</p>
					<div class="meta-row">
						<div class="meta-item">
							<span class="label">ISSN</span>
							<span class="value">{journal.issn}</span>
						</div>
						<div class="meta-item">
							<span class="label">Impact Factor</span>
							<span class="value">{journal.impactFactor}</span>
						</div>
						<div class="meta-item">
							<span class="label">Field</span>
							<span class="value">{journal.field}</span>
						</div>
						{journal.isMain && (
							<div class="meta-item">
								<span class="label">Journal Type</span>
								<span class="value" style="color: #ffcc80;">Flagship Journal</span>
							</div>
						)}
					</div>
					<p class="description">{journal.description}</p>
					<div style="margin-top: 1.25rem; display: flex; gap: 0.75rem;">
						<a href="/author/submit" class="btn btn-sm btn-danger">
							Submit Manuscript
						</a>
						<a href="/join-editorial-board" class="btn btn-sm btn-secondary" style="border-color: rgba(255,255,255,0.3); color: #fff;">
							Join Editorial Board
						</a>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Journal Tabs -->
	<div class="journal-tabs">
		<div class="container">
			<div class="journal-tabs-inner">
				<a
					href={`/journals/${slug}?tab=articles`}
					class={`journal-tab${tab === "articles" ? " active" : ""}`}
				>
					Latest Articles
				</a>
				<a
					href={`/journals/${slug}?tab=board`}
					class={`journal-tab${tab === "board" ? " active" : ""}`}
				>
					Editorial Board
				</a>
				<a
					href={`/journals/${slug}?tab=submit`}
					class={`journal-tab${tab === "submit" ? " active" : ""}`}
				>
					Submit
				</a>
			</div>
		</div>
	</div>

	<!-- Tab Content -->
	<div class="page-content">
		<div class="container">

			{/* Articles Tab */}
			{tab === "articles" && (
				<div>
					<div class="section-header">
						<h2 class="section-title">Latest Published Articles</h2>
					</div>

					{displayArticles.length === 0 ? (
						<div class="alert alert-info">
							No published articles yet. <a href="/author/submit">Submit a manuscript</a> to get started!
						</div>
					) : (
						<div style="display: flex; flex-direction: column; gap: 1.25rem;">
							{displayArticles.map((article) => (
								<article class="article-card" style="display: grid; grid-template-columns: 1fr auto; gap: 1rem; align-items: start;">
									<div>
										<h3 style="font-size: 1.05rem; margin-bottom: 0.5rem;">{article.title}</h3>
										<p class="authors">{article.authors}</p>
										<p class="excerpt">{article.abstract}</p>
										<div class="meta">
											<span>
												{new Date(article.published_at).toLocaleDateString("en-US", {
													year: "numeric",
													month: "long",
													day: "numeric",
												})}
											</span>
											{article.doi && (
												<span class="font-mono" style="font-size: 0.75rem;">
													DOI: {article.doi}
												</span>
											)}
											{article.volume && (
												<span>Vol. {article.volume}, No. {article.issue}</span>
											)}
										</div>
									</div>
									<div style="flex-shrink: 0; display: flex; flex-direction: column; gap: 0.5rem; align-items: flex-end;">
										{article.r2_key && (
											<a
												href={`/api/download/${encodeURIComponent(article.r2_key)}`}
												class="btn btn-sm btn-primary"
											>
												Download PDF
											</a>
										)}
									</div>
								</article>
							))}
						</div>
					)}
				</div>
			)}

			{/* Editorial Board Tab */}
			{tab === "board" && (
				<div>
					<div class="section-header">
						<h2 class="section-title">Editorial Board</h2>
						<a href="/join-editorial-board" class="btn btn-sm btn-primary">
							Apply to Join
						</a>
					</div>

					{/* Chief Editor(s) */}
					{displayBoard.filter((m) => m.is_editor_in_chief).length > 0 && (
						<div style="margin-bottom: 2rem;">
							<h3 style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 1rem; font-family: var(--font-sans); font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;">
								Editors in Chief
							</h3>
							<div class="board-grid" style="grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));">
								{displayBoard
									.filter((m) => m.is_editor_in_chief)
									.map((member) => (
										<div class="board-member" style="border-top: 3px solid var(--accent);">
											<div class="board-member-avatar" style="background: var(--accent);">
												{(member.name || "?").charAt(0).toUpperCase()}
											</div>
											<div class="board-member-name">{member.name}</div>
											<div class="board-member-position" style="color: var(--accent);">{member.position || "Editor in Chief"}</div>
											<div class="board-member-affiliation">{member.affiliation}</div>
											{member.orcid && (
												<a href={`https://orcid.org/${member.orcid}`} target="_blank" style="font-size:0.75rem;color:var(--text-light);margin-top:0.35rem;display:block;">
													ORCID: {member.orcid}
												</a>
											)}
											{member.bio && (
												<p style="font-size: 0.78rem; color: var(--text-light); margin-top: 0.5rem; line-height: 1.5;">
													{member.bio}
												</p>
											)}
										</div>
									))}
							</div>
						</div>
					)}

					{/* Associate Editors */}
					{displayBoard.filter((m) => !m.is_editor_in_chief && m.position === "Associate Editor").length > 0 && (
						<div style="margin-bottom: 2rem;">
							<h3 style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 1rem; font-family: var(--font-sans); font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;">
								Associate Editors
							</h3>
							<div class="board-grid">
								{displayBoard
									.filter((m) => !m.is_editor_in_chief && m.position === "Associate Editor")
									.map((member) => (
										<div class="board-member" style="border-top: 2px solid #E65100;">
											<div class="board-member-avatar" style="background: #E65100;">
												{(member.name || "?").charAt(0).toUpperCase()}
											</div>
											<div class="board-member-name">{member.name}</div>
											<div class="board-member-position" style="color:#E65100;">{member.position}</div>
											<div class="board-member-affiliation">{member.affiliation}</div>
											{member.orcid && (
												<a href={`https://orcid.org/${member.orcid}`} target="_blank" style="font-size:0.75rem;color:var(--text-light);margin-top:0.35rem;display:block;">
													ORCID: {member.orcid}
												</a>
											)}
										</div>
									))}
							</div>
						</div>
					)}

					{/* Editorial Board Members */}
					<div>
						<h3 style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 1rem; font-family: var(--font-sans); font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em;">
							Editorial Board Members
						</h3>
						<div class="board-grid">
							{displayBoard
								.filter((m) => !m.is_editor_in_chief && m.position !== "Associate Editor")
								.map((member) => (
									<div class="board-member">
										<div class="board-member-avatar">
											{(member.name || "?").charAt(0).toUpperCase()}
										</div>
										<div class="board-member-name">{member.name}</div>
										<div class="board-member-position">{member.position || "Editorial Board Member"}</div>
										<div class="board-member-affiliation">{member.affiliation}</div>
										{member.orcid && (
											<a href={`https://orcid.org/${member.orcid}`} target="_blank" style="font-size:0.75rem;color:var(--text-light);margin-top:0.35rem;display:block;">
												ORCID: {member.orcid}
											</a>
										)}
									</div>
								))}
						</div>
					</div>
				</div>
			)}

			{/* Submit Guide Tab */}
			{tab === "submit" && (
				<div style="max-width: 760px;">
					<h2 class="section-title" style="margin-bottom: 1.5rem;">Submission Guide</h2>

					<div class="card">
						<div class="card-header">
							<h3 style="font-size: 1rem;">Scope &amp; Aims</h3>
						</div>
						<div class="card-body">
							<p>{journal.description}</p>
							<p>We accept original research articles, review articles, research letters, and commentary. All submissions must be unpublished and not under consideration elsewhere.</p>
						</div>
					</div>

					<div class="card" style="margin-top: 1rem;">
						<div class="card-header">
							<h3 style="font-size: 1rem;">Submission Requirements</h3>
						</div>
						<div class="card-body">
							<ul style="list-style: disc; padding-left: 1.5rem; color: var(--text-secondary);">
								<li style="margin-bottom: 0.5rem;">Format: PDF (preferred) or Word document</li>
								<li style="margin-bottom: 0.5rem;">File size: Maximum 50 MB</li>
								<li style="margin-bottom: 0.5rem;">Language: English or Chinese</li>
								<li style="margin-bottom: 0.5rem;">Abstract: Maximum 300 words</li>
								<li style="margin-bottom: 0.5rem;">Keywords: 3&ndash;8 keywords</li>
								<li>Citation style: APA or MLA (must be consistent throughout)</li>
							</ul>
						</div>
					</div>

					<div class="card" style="margin-top: 1rem;">
						<div class="card-header">
							<h3 style="font-size: 1rem;">Peer Review Process</h3>
						</div>
						<div class="card-body">
							<ol style="list-style: decimal; padding-left: 1.5rem; color: var(--text-secondary);">
								<li style="margin-bottom: 0.75rem;">Author submits manuscript &rarr; System assigns tracking number</li>
								<li style="margin-bottom: 0.75rem;">Editor desk review &rarr; If passed, sent for peer review</li>
								<li style="margin-bottom: 0.75rem;">Double-blind peer review (2&ndash;3 reviewers)</li>
								<li style="margin-bottom: 0.75rem;">Editor synthesizes reviews and issues Accept / Revise / Reject decision</li>
								<li style="margin-bottom: 0.75rem;">Revised manuscript resubmitted &rarr; may go back for another round</li>
								<li>Final acceptance &rarr; Typesetting &rarr; Publication</li>
							</ol>
						</div>
					</div>

					<div style="margin-top: 1.5rem; text-align: center;">
						<a href="/author/submit" class="btn btn-lg btn-primary">
							Submit Manuscript
						</a>
						<p style="margin-top: 0.75rem; font-size: 0.875rem; color: var(--text-light);">
							You need to <a href="/register">create an account</a> before submitting.
						</p>
					</div>
				</div>
			)}

		</div>
	</div>
</BaseLayout>
