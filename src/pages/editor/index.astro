---
import DashboardLayout from "../../layouts/DashboardLayout.astro";
import { getJournalById } from "../../data/journals";

const user = Astro.locals.user!;
const env = Astro.locals.runtime?.env;

let manuscripts: any[] = [];
let stats = { submitted: 0, under_review: 0, revision: 0, total: 0 };
let reviewers: any[] = [];

const journal = user.journalId ? getJournalById(user.journalId) : null;

try {
	if (env?.DB && user.journalId) {
		const result = await env.DB.prepare(`
			SELECT m.*, u.name as submitter_name
			FROM manuscripts m
			JOIN users u ON m.submitter_id = u.id
			WHERE m.journal_id = ?
			ORDER BY m.updated_at DESC
		`).bind(user.journalId).all();
		manuscripts = result.results as any[];

		for (const m of manuscripts) {
			stats.total++;
			if (m.status === "submitted") stats.submitted++;
			else if (m.status === "under_review" || m.status === "resubmitted") stats.under_review++;
			else if (m.status === "revision_requested") stats.revision++;
		}

		// Get reviewers for this journal
		const rResult = await env.DB.prepare(`
			SELECT u.id, u.name, u.email, u.affiliation
			FROM users u
			WHERE u.role = 'reviewer' AND u.journal_id = ?
		`).bind(user.journalId).all();
		reviewers = rResult.results as any[];
	}
} catch (e) {
	// DB not available
}

const statusLabel: Record<string, string> = {
	submitted: "æ–°æäº¤",
	under_review: "å®¡ç¨¿ä¸­",
	revision_requested: "å¾…ä¿®æ”¹",
	resubmitted: "å·²ä¿®æ”¹",
	accepted: "å·²æ¥å—",
	rejected: "å·²æ‹’ç¨¿",
	published: "å·²å‘è¡¨",
};

const statusBadge: Record<string, string> = {
	submitted: "badge-submitted",
	under_review: "badge-under-review",
	revision_requested: "badge-revision",
	resubmitted: "badge-resubmitted",
	accepted: "badge-accepted",
	rejected: "badge-rejected",
	published: "badge-published",
};

const filterStatus = new URL(Astro.request.url).searchParams.get("status") || "";
const displayManuscripts = filterStatus
	? manuscripts.filter((m) => m.status === filterStatus)
	: manuscripts;
---

<DashboardLayout title="ç¼–è¾‘å·¥ä½œå°" activeNav="/editor">
	<h1 class="dashboard-page-title">
		ğŸ“‹ ç¼–è¾‘å·¥ä½œå°
		{journal && <span style="font-size: 0.875rem; color: var(--text-secondary); font-weight: 400;">â€” {journal.name}</span>}
	</h1>

	{!user.journalId && (
		<div class="alert alert-info">
			æ‚¨çš„ç¼–è¾‘è´¦å·å°šæœªå…³è”æœŸåˆŠï¼Œè¯·è”ç³»ç³»ç»Ÿç®¡ç†å‘˜åˆ†é…æœŸåˆŠã€‚
		</div>
	)}

	<!-- Stats -->
	<div class="stats-row">
		<div class="stat-card">
			<div class="number">{stats.total}</div>
			<div class="label">ç¨¿ä»¶æ€»æ•°</div>
		</div>
		<div class="stat-card">
			<div class="number" style="color: var(--orange);">{stats.submitted}</div>
			<div class="label">å¾…å¤„ç†</div>
		</div>
		<div class="stat-card">
			<div class="number" style="color: var(--primary);">{stats.under_review}</div>
			<div class="label">å®¡ç¨¿ä¸­</div>
		</div>
		<div class="stat-card">
			<div class="number" style="color: var(--purple);">{stats.revision}</div>
			<div class="label">å¾…ä¿®æ”¹</div>
		</div>
	</div>

	<!-- Filter tabs -->
	<div style="display: flex; gap: 0.5rem; margin-bottom: 1.25rem; flex-wrap: wrap;">
		{[
			{ value: "", label: "å…¨éƒ¨" },
			{ value: "submitted", label: "æ–°æäº¤" },
			{ value: "under_review", label: "å®¡ç¨¿ä¸­" },
			{ value: "revision_requested", label: "å¾…ä¿®æ”¹" },
			{ value: "resubmitted", label: "å·²ä¿®æ”¹" },
			{ value: "accepted", label: "å·²æ¥å—" },
			{ value: "rejected", label: "å·²æ‹’ç¨¿" },
		].map((f) => (
			<a
				href={`/editor${f.value ? `?status=${f.value}` : ""}`}
				class={`btn btn-sm ${filterStatus === f.value ? "btn-primary" : "btn-secondary"}`}
			>
				{f.label}
			</a>
		))}
	</div>

	<!-- Manuscripts table -->
	{displayManuscripts.length === 0 ? (
		<div class="alert alert-info">
			æš‚æ— {filterStatus ? statusLabel[filterStatus] : ""}ç¨¿ä»¶ã€‚
		</div>
	) : (
		<table class="manuscript-table">
			<thead>
				<tr>
					<th>ç¨¿ä»¶æ ‡é¢˜</th>
					<th>æŠ•ç¨¿ä½œè€…</th>
					<th>æŠ•ç¨¿æ—¶é—´</th>
					<th>çŠ¶æ€</th>
					<th>æ“ä½œ</th>
				</tr>
			</thead>
			<tbody>
				{displayManuscripts.map((m) => (
					<tr>
						<td class="manuscript-title-cell">
							<a href={`/editor/manuscript/${m.id}`}>{m.title}</a>
						</td>
						<td class="text-sm text-muted">{m.submitter_name}</td>
						<td class="text-sm text-muted">
							{new Date(m.created_at).toLocaleDateString("zh-CN")}
						</td>
						<td>
							<span class={`badge ${statusBadge[m.status] || "badge-submitted"}`}>
								{statusLabel[m.status] || m.status}
							</span>
						</td>
						<td>
							<div style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
								<a href={`/editor/manuscript/${m.id}`} class="btn btn-sm btn-secondary">
									æŸ¥çœ‹
								</a>
								{m.status === "submitted" && (
									<>
										<a href={`/editor/manuscript/${m.id}?action=assign`} class="btn btn-sm btn-primary">
											åˆ†é…å®¡ç¨¿äºº
										</a>
										<a href={`/editor/manuscript/${m.id}?action=desk-reject`} class="btn btn-sm btn-danger">
											æ¡Œå®¡æ‹’ç¨¿
										</a>
									</>
								)}
								{(m.status === "under_review" || m.status === "resubmitted") && (
									<a href={`/editor/manuscript/${m.id}?action=decide`} class="btn btn-sm btn-warning">
										ä½œå‡ºå†³å®š
									</a>
								)}
							</div>
						</td>
					</tr>
				))}
			</tbody>
		</table>
	)}
</DashboardLayout>
